// use strict;
var app = angular.module('PencilApp', ['ui.router']);
var storage = localStorage;
app.factory('$localstorage', ['$window', function($window) {
  return {
    set: function(key, value) {
      $window.localStorage[key] = value;
    },
    get: function(key, defaultValue) {
      return $window.localStorage[key] || false;
    },
    setObject: function(key, value) {
      $window.localStorage[key] = JSON.stringify(value);
    },
    getObject: function(key) {
      if($window.localStorage[key] != undefined){
        return JSON.parse( $window.localStorage[key] || false );
      }
      return false;   
    },
    remove: function(key){
      $window.localStorage.removeItem(key);
    },
    clear: function(){
      $window.localStorage.clear();
    }
  }
}]);

app.config(['$stateProvider', '$urlRouterProvider', function ($stateProvider, $urlRouterProvider) {
    //$urlRouterProvider.when("", "/order/list");
    //$urlRouterProvider.when("/", "/order/list");
    $stateProvider
        .state('home', {
            url: '/home',
            templateUrl: 'partials/home.html',
        })

        .state('order', {
            abstract: true,
            url: "/order",
            templateUrl: "partials/order.html",
            controller: "gridCtrl"
        })

        .state('order.list', {
            url: "/list",
            templateUrl: "partials/list.html"
        })

        .state('order.detail', {
            url: '/:id',
            templateUrl: 'partials/details.html',
            controller: 'gridCtrl'
        })

        .state('cart', {
            url: "/cart",
            templateUrl: "partials/cart.html",
            controller: "tableCtrl"
        })

        $urlRouterProvider.otherwise("/home");
}]);

app.controller('gridCtrl', ['$scope', '$http', '$filter', '$stateParams', '$localstorage', function($scope, $http, $filter, $stateParams, $localstorage){
    $http.get('../data/products.json').then(function (response) {
        function chunk(arr, size){
            var newArr = [];
            for (var i=0; i<arr.length; i+=size) {
                newArr.push(arr.slice(i, i+size));
            };
            return newArr;
        };
        var a = chunk(response.data, 3);
        console.log(a);
        $scope.pencilsGroup = a;

        var id = $stateParams.id;
        var pencilDetails;
        for(var i=0; i<$scope.pencilsGroup.length; i++){
            for(var j=0; j<$scope.pencilsGroup[i].length; j++){
                if($scope.pencilsGroup[i][j].id.includes(id)){
                    pencilDetails = $scope.pencilsGroup[i][j];
                };
            };
        };
        $scope.input = {};
        $scope.details = pencilDetails;
        $scope.input.quantity = 1;
        var c = [{name:"Black", code:"000000"},{name:"Red", code:"FF0000"},{name:"Green", code:"008000"},{name:"Blue", code:"0000FF"}];
        $scope.colors = c;
        $scope.input.color = $scope.colors[0];
    });

    // var s = $localstorage.setObject('1','a');
    // console.log($localstorage.getObject('1'));

    $scope.addToCart = function () {
        var name = $scope.details.name;
        var quantity = $scope.input.quantity;
        console.log(quantity);
        var color = $scope.input.color.name;
        var unitPrice = $scope.details.price;
        var total = unitPrice * quantity;
        console.log(total);
        var get = $localstorage.getObject(name);
        console.log(get);
         var item = {};
        
        if(get){
            if(get[color] != undefined){
                quantity += get[color].quantity;
                total += get[color].total;
                console.log('get is true and color existed');
                console.log(get);
                get[color] = {"unitPrice":unitPrice, "quantity":quantity,"total":total};
                $localstorage.setObject(name, get);
            } else {
                console.log('get is true and color not existed');
                console.log(get);
                get[color] = {"unitPrice":unitPrice, "quantity":quantity,"total":total};
                $localstorage.setObject(name, get);
            }
            
           //get[color] = item;
            
        //     var item = {};
        } else{
            console.log('get is false');
            item[color] = {"unitPrice":unitPrice, "quantity":quantity,"total":total};
            $localstorage.setObject(name, item);
            //item[color] = {"unitPrice":unitPrice, "quantity":quantity,"total":total};
            
        };
        // var item = {};
        // item[color] = {"unitPrice":unitPrice, "quantity":quantity,"total":total};
        // $localstorage.setObject(name, item);
        
     };
}]);

app.controller('tableCtrl',['$scope', '$localstorage', function($scope, $localstorage){
    var cart = {};
    // var i = 1;
    for(var key in storage){
        //var parsed = JSON.parse(key);
        // console.log(key)
        // var value = $localstorage.getObject(key);
        // console.log(parsed);
        // console.log(value);
        // cart["item "+i] = {"name":parsed.name, "color":parsed.color, "unitPrice":parsed.unitPrice,
        //                     "quantity":value.quantity, "total":value.total};
        // console.log(cart);
        // i++;
        var temp = $localstorage.getObject(key);
        console.log(temp);
        //temp["name"] = key;
        cart[key] = temp;
    }
    console.log(cart);
    $scope.cart = cart;
    $scope.decrease = function(key, color, item){
        if(item.quantity > 0){
            item.quantity--;
            var object = $localstorage.getObject(key);
            console.log(object);
            var temp = object[color];
            console.log(temp);
            temp.quantity--;
            var total = temp.unitPrice * item.quantity;
            temp.total = total;
            object[color] = temp;
            $localstorage.setObject(key, object);
            item.total = total;
        };
    };
    
    $scope.increase = function(key, color, item){
        item.quantity++;
        var object = $localstorage.getObject(key);
        console.log(object);
        var temp = object[color];
        console.log(temp);
        temp.quantity++;
        var total = temp.unitPrice * item.quantity;
        temp.total = total;
        object[color] = temp;
        $localstorage.setObject(key, object);
        item.total = total;
    };
    
}]);



// app.factory('Storage', function(){
    
// });


// app.service('globalData', function(){
//     $localstorage.set('a', 3);
// });